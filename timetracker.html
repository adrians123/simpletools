<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker – szybki i lekki</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#11131a; --ink:#e9eef4; --muted:#a9b4c0;
      --brd:#1f2333; --accent:#41c3ff; --accent-ink:#000; --soft:#1a1d29; --danger:#ff7a7a; --warn:#ffd36e;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:20px}
    h1{margin:0 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;margin-bottom:16px}
    input,select{padding:10px;border-radius:8px;border:1px solid #394055;background:#0e1118;color:var(--ink)}
    input[type="date"]{color-scheme:dark}
    button{padding:10px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .btn-add{background:var(--accent);color:var(--accent-ink)}
    .btn-sec{background:var(--soft);color:var(--ink)}
    .btn-warn{background:var(--warn);color:#000}
    .btn-danger{background:var(--danger);color:#000}
    .task{border:1px solid var(--brd);border-radius:12px;margin:10px 0;overflow:hidden}
    .task-header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 10px;background:#121623}
    .task-title{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .task-name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .task-time{font-weight:800}
    .task-controls{display:flex;gap:8px;flex-wrap:wrap}
    .play{background:var(--accent);color:var(--accent-ink)}
    .pause{background:var(--warn);color:#000}
    details{background:#0f1320}
    details > summary{list-style:none;cursor:pointer;padding:10px 12px;border-top:1px solid var(--brd);display:flex;align-items:center;gap:10px}
    details[open] > summary{background:#0e1220}
    .sessions{padding:8px 12px 12px}
    .session{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:6px 0;border-bottom:1px dashed #2a3044}
    .session:last-child{border-bottom:none}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#1c2134;border:1px solid #2a3150;color:var(--muted)}
    .sumline{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:6px;border-top:1px solid #23273a}
  </style>
</head>
<body>
  <div style="margin-bottom:15px">
  <a href="index.html" style="
    display:inline-block;
    padding:8px 14px;
    background:#41c3ff;
    color:#000;
    font-weight:700;
    border-radius:8px;
    text-decoration:none;
    ">
    ⬅️ Powrót do strony głównej
  </a>
</div>

  <h1>⏱️ Time Tracker</h1>

  <div class="card">
    <div class="row">
      <input id="taskName" placeholder="Nazwa czynności (np. Kopanie otworu, Mieszanie betonu)" style="flex:1;min-width:220px">
      <button class="btn-add" onclick="addTask()">Dodaj</button>
      <button class="btn-sec" onclick="stopAll()">⏹️ Stop wszystko</button>
      <button class="btn-danger" onclick="clearAll()">🗑️ Wyczyść wszystko</button>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="tiny muted">Filtruj historię po dniu:</label>
      <input type="date" id="filterDate" onchange="render()" />
      <button class="btn-sec" onclick="clearFilter()">Wyczyść filtr</button>
      <span class="tiny muted">* Filtr dotyczy listy sesji; suma przy nazwie to łączny czas czynności.</span>
    </div>
  </div>

  <div id="taskList" class="card"></div>

  <script>
    // ===== UTIL =====
    const pad = n => n.toString().padStart(2,'0');
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    function fmtDuration(ms){
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${h}h ${pad(m)}m ${pad(sec)}s`;
    }
    function fmtDateTime(ts){
      const d = new Date(ts);
      const Y = d.getFullYear();
      const M = pad(d.getMonth()+1);
      const D = pad(d.getDate());
      const hh = pad(d.getHours());
      const mm = pad(d.getMinutes());
      const ss = pad(d.getSeconds());
      return `${Y}-${M}-${D} ${hh}:${mm}:${ss}`;
    }
    function dayBounds(dateStr){
      if(!dateStr) return null;
      const d = new Date(dateStr+'T00:00:00');
      const start = d.getTime();
      const end = start + 24*3600*1000 - 1;
      return {start, end};
    }
    function overlapMs(aStart,aEnd,bStart,bEnd){
      const s = Math.max(aStart, bStart);
      const e = Math.min(aEnd, bEnd);
      return Math.max(0, e - s);
    }

    // ===== STATE =====
    let tasks = load() || [];

    function load(){
      try{
        const raw = localStorage.getItem('time-tracker-tasks');
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return arr.map(t => ({
          id: t.id,
          name: t.name,
          time: t.time||0,
          active: !!t.active,
          lastStart: t.lastStart||null,
          sessions: Array.isArray(t.sessions)? t.sessions.map(s=>({
            start: s.start,
            end: s.end ?? null
          })) : []
        }));
      }catch(e){ return []; }
    }
    function save(){
      localStorage.setItem('time-tracker-tasks', JSON.stringify(tasks));
    }

    // ===== ACTIONS =====
    function addTask(){
      const name = qs('#taskName').value.trim();
      if(!name) return;
      const id = Date.now();
      tasks.push({id, name, time:0, active:false, lastStart:null, sessions:[]});
      qs('#taskName').value='';
      save(); render();
    }

    function toggleTask(id){
      const now = Date.now();
      tasks.forEach(t=>{
        if(t.id===id){
          if(!t.active){
            t.active=true;
            t.lastStart=now;
            t.sessions.push({start: now, end: null});
          } else {
            t.active=false;
            t.time += (now - t.lastStart);
            const last = t.sessions[t.sessions.length-1];
            if(last && last.end===null) last.end = now;
            t.lastStart=null;
          }
        } else {
          if(t.active){
            t.active=false;
            t.time += (now - t.lastStart);
            const last = t.sessions[t.sessions.length-1];
            if(last && last.end===null) last.end = now;
            t.lastStart=null;
          }
        }
      });
      save(); render();
    }

    function stopAll(){
      const now = Date.now();
      tasks.forEach(t=>{
        if(t.active){
          t.active=false;
          t.time += (now - t.lastStart);
          const last = t.sessions[t.sessions.length-1];
          if(last && last.end===null) last.end = now;
          t.lastStart=null;
        }
      });
      save(); render();
    }

    function clearAll(){
      if(!confirm('Na pewno usunąć wszystkie czynności i historię?')) return;
      tasks = [];
      save(); render();
    }

    function deleteTask(id){
      if(!confirm('Usunąć tę czynność i całą jej historię?')) return;
      const wasActive = tasks.find(t=>t.id===id && t.active);
      if(wasActive) stopAll();
      tasks = tasks.filter(t=>t.id!==id);
      save(); render();
    }

    function deleteSession(taskId, idx){
      const t = tasks.find(x=>x.id===taskId);
      if(!t) return;
      const s = t.sessions[idx];
      if(!s) return;
      if(t.active && s.end===null){ stopAll(); }
      t.sessions.splice(idx,1);
      // przelicz sumę z sesji
      t.time = t.sessions.reduce((acc,ss)=> acc + ((ss.end??Date.now()) - ss.start), 0);
      if(t.active && t.lastStart){
        t.time -= (Date.now() - t.lastStart);
      }
      save(); render();
    }

    function clearFilter(){
      qs('#filterDate').value = '';
      render();
    }

    // ===== RENDER (pełny) =====
    function render(){
      const list = qs('#taskList');
      const f = qs('#filterDate').value;
      const bounds = dayBounds(f);

      list.innerHTML='';

      tasks.forEach(t=>{
        // kontener zadania
        const wrap = document.createElement('div');
        wrap.className='task';
        wrap.dataset.taskId = t.id;

        // header
        const head = document.createElement('div');
        head.className='task-header';

        const title = document.createElement('div');
        title.className='task-title';

        const nameEl = document.createElement('div');
        nameEl.className='task-name';
        nameEl.textContent = t.name;

        const timeEl = document.createElement('div');
        timeEl.className='task-time';
        timeEl.dataset.bind = 'total'; // do tick()
        title.appendChild(nameEl);
        title.appendChild(timeEl);

        const ctrls = document.createElement('div');
        ctrls.className='task-controls';

        const playBtn = document.createElement('button');
        playBtn.className = t.active ? 'pause' : 'play';
        playBtn.textContent = t.active ? '⏸️ Pauza' : '▶️ Start';
        playBtn.onclick = ()=>toggleTask(t.id);

        const delTaskBtn = document.createElement('button');
        delTaskBtn.className='btn-danger';
        delTaskBtn.textContent = '🗑️ Usuń czynność';
        delTaskBtn.onclick = ()=>deleteTask(t.id);

        ctrls.appendChild(playBtn);
        ctrls.appendChild(delTaskBtn);

        head.appendChild(title);
        head.appendChild(ctrls);

        // details (historia)
        const det = document.createElement('details');
        det.dataset.id = t.id; // stabilny id (nie nadpisujemy co sekundę)
        const sum = document.createElement('summary');
        sum.innerHTML = '📜 Rozwiń historię ' + (bounds? `<span class="badge">filtr: ${f}</span>` : '');
        det.appendChild(sum);

        const sesWrap = document.createElement('div');
        sesWrap.className='sessions';

        const filtered = bounds
          ? t.sessions.filter(s=>{
              const start = s.start;
              const end = s.end ?? Date.now();
              return overlapMs(start,end,bounds.start,bounds.end) > 0;
            })
          : t.sessions.slice();

        if(filtered.length===0){
          const p = document.createElement('div');
          p.className='muted tiny';
          p.textContent = bounds ? 'Brak sesji w wybranym dniu.' : 'Brak sesji.';
          sesWrap.appendChild(p);
        } else {
          filtered.forEach((s)=>{
            const origIdx = t.sessions.indexOf(s);
            const row = document.createElement('div');
            row.className='session';

            const when = document.createElement('div');
            when.innerHTML = `<span class="muted tiny">start</span> ${fmtDateTime(s.start)}`
              + (s.end ? ` <span class="muted tiny">— stop</span> ${fmtDateTime(s.end)}` : ` <span class="badge">w trakcie</span>`);

            const dur = document.createElement('div');
            dur.innerHTML = `<strong data-bind="sess" data-start="${s.start}" data-end="${s.end??''}"></strong>`;

            const delBtn = document.createElement('button');
            delBtn.className='btn-warn';
            delBtn.textContent='Usuń rekord';
            delBtn.onclick=()=>deleteSession(t.id, origIdx);

            row.appendChild(when);
            row.appendChild(dur);
            row.appendChild(delBtn);

            sesWrap.appendChild(row);
          });

          const sumLine = document.createElement('div');
          sumLine.className='sumline tiny';
          sumLine.innerHTML = `<span class="muted">Suma ${bounds? 'dla dnia '+f : 'wszystkich sesji'}</span> <strong data-bind="daySum"></strong>`;
          sesWrap.appendChild(sumLine);
        }

        det.appendChild(sesWrap);

        wrap.appendChild(head);
        wrap.appendChild(det);
        list.appendChild(wrap);
      });

      // po pełnym renderze od razu odśwież wyświetlacze
      tick();
    }

    // ===== TICK (tylko aktualizacja liczb na ekranie) =====
    function tick(){
      const f = qs('#filterDate').value;
      const bounds = dayBounds(f);

      tasks.forEach(t=>{
        // total time
        let total = t.time;
        if(t.active && t.lastStart){
          total += (Date.now() - t.lastStart);
        }
        const taskEl = qs(`.task[data-task-id="${t.id}"]`);
        if(!taskEl) return;
        const totalEl = taskEl.querySelector('[data-bind="total"]');
        if(totalEl) totalEl.textContent = fmtDuration(total);

        // per-session and day sum (only visible sessions – filtered at render)
        let daySum = 0;
        taskEl.querySelectorAll('[data-bind="sess"]').forEach(el=>{
          const start = +el.dataset.start;
          const endAttr = el.dataset.end;
          const end = endAttr ? +endAttr : Date.now();
          const dur = bounds ? overlapMs(start, end, bounds.start, bounds.end)
                             : (end - start);
          el.textContent = fmtDuration(dur);
          daySum += dur;
        });
        const daySumEl = taskEl.querySelector('[data-bind="daySum"]');
        if(daySumEl) daySumEl.textContent = fmtDuration(daySum);
      });
    }

    // auto-tick co sekundę (bez re-renderu)
    setInterval(tick, 1000);

    // start
    render();
  </script>
</body>
</html>
